{% extends "base.html" %}

{% block title %}Charakter Manager - RPG Character Manager{% endblock %}

{% block content %}
<div class="app-wrapper">
    <div class="character-list">
        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            {% if current_user.is_authenticated %}
            <!-- User Info -->
            <div id="userInfo">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">{{ current_user.username[0].upper() }}</div>
                    <div class="user-details">
                        <p class="username" id="currentUsername">{{ current_user.username }}</p>
                        <p class="user-meta" id="userMeta">Angemeldet</p>
                    </div>
                    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
                </div>
            </div>
            {% else %}
            <!-- Login Form -->
            <div id="loginForm">
                <h4>🔐 Login</h4>
                <form class="auth-form" method="POST" action="{{ url_for('login') }}">
                    <input type="text" class="auth-input" name="username" placeholder="Benutzername" required>
                    <input type="password" class="auth-input" name="password" placeholder="Passwort" required>
                    <button type="submit" class="auth-btn">Einloggen</button>
                </form>
                <div class="auth-toggle" id="showRegister">Noch kein Account? Registrieren</div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h4>📝 Registrieren</h4>
                <form class="auth-form" method="POST" action="{{ url_for('register') }}">
                    <input type="text" class="auth-input" name="username" placeholder="Benutzername" required>
                    <input type="email" class="auth-input" name="email" placeholder="E-Mail" required>
                    <input type="password" class="auth-input" name="password" placeholder="Passwort" required>
                    <input type="password" class="auth-input" name="confirm_password" placeholder="Passwort bestätigen" required>
                    <button type="submit" class="auth-btn">Registrieren</button>
                </form>
                <div class="auth-toggle" id="showLogin">Bereits registriert? Einloggen</div>
            </div>
            {% endif %}
        </div>

        <h3>Meine Charaktere</h3>
        <div id="character-list-content">
            {% if current_user.is_authenticated %}
                {% for character in characters %}
                <div class="character-item" data-char-id="{{ character.id }}">
                    <div class="character-avatar"
                         {% if character.image_data %}
                         style="background-image: url('data:image/jpeg;base64,{{ character.get_image_base64() }}')"
                         {% endif %}></div>
                    <div class="character-info">
                        <p class="character-name">{{ character.name }}</p>
                    </div>
                    <div class="character-actions">
                        <button class="char-btn load" onclick="loadCharacter({{ character.id }})">Laden</button>
                        <button class="char-btn delete" onclick="deleteCharacter({{ character.id }})">×</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="character-item opacity-05 text-center padding-20">
                <div class="tiny">Login required</div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="app">
        <div class="main-content">
            <h1>Charakter Manager</h1>

            <div class="topbar">
                <div class="top-left">
                    <label class="btn neutral file-loader-label">
                        Dateien laden
                        <input id="fileLoader" type="file" accept=".json,.txt" multiple class="hidden">
                    </label>
                    <div id="dropzone" class="drop">Dateien hier ablegen, um Tabs zu erzeugen</div>
                </div>
                <div class="tiny" style="text-align:right">Speichern lädt Dateien herunter (JSON / PNG).</div>
            </div>

            <div class="tabs" id="tabs">
                <button class="btn btn-add" id="btnNew">+ Neuer Charakter</button>
            </div>

            <div class="panels" id="panels"></div>
        </div>
    </div>

    <div class="chat-container">
        <!-- Chat Tabs (Rooms) -->
        <div class="chat-tabs">
            <div class="chat-tab-controls">
                <button class="btn btn-sm" id="joinRoomBtn">📥 Beitreten</button>
                <button class="btn btn-sm" id="createRoomBtn">➕ Erstellen</button>
                <button class="btn btn-sm" id="chatSettingsBtn">⚙️ Settings</button>
            </div>
            <div class="chat-room-tabs" id="chatRoomTabs">
                <!-- Dynamically populated room tabs -->
            </div>
        </div>

        <!-- Active Chat Content -->
        <div class="chat-content-wrapper">
            <div class="chat-header">
                <h4 id="activeRoomName">Allgemein</h4>
                <button class="btn btn-sm" id="memberListBtn">👥</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="chat-placeholder">
                    Wähle einen Raum oder erstelle einen neuen Raum...
                </div>
            </div>

            <div class="chat-input-section">
                <div class="chat-input-wrapper">
                    <input type="text" id="chatInput" placeholder="Nachricht schreiben..." maxlength="3000" disabled>
                    <button id="sendBtn" disabled>📤</button>
                    <button id="shareCharBtn" disabled>📋</button>
                </div>
            </div>
        </div>

        <!-- Member Sidebar (toggleable) -->
        <div class="member-sidebar hidden" id="memberSidebar">
            <div class="member-header">
                <h5>Mitglieder</h5>
                <button class="btn btn-sm" id="closeMemberBtn">✕</button>
            </div>
            <div class="member-list" id="memberList">
                <!-- Populated dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Room Creation Modal -->
<div class="modal" id="createRoomModal">
    <div class="modal-content">
        <h3>🏠 Neuen Raum erstellen</h3>
        <form id="createRoomForm">
            <input type="text" name="roomName" placeholder="Raumname" required>
            <textarea name="description" placeholder="Beschreibung (optional)"></textarea>
            <label>
                <input type="checkbox" name="isPrivate" id="isPrivateCheck"> Privater Raum (Passwort erforderlich)
            </label>
            <input type="password" name="password" placeholder="Passwort (optional)" class="hidden" id="roomPassword">
            <div class="modal-actions">
                <button type="submit" class="btn" id="createRoomSubmit">Erstellen</button>
                <button type="button" class="btn neutral" onclick="closeModal('createRoomModal')">Abbrechen</button>
            </div>
        </form>
    </div>
</div>

<!-- Join Room Modal -->
<div class="modal" id="joinRoomModal">
    <div class="modal-content">
        <h3>📥 Raum beitreten</h3>
        <div class="available-rooms" id="availableRooms">
            <!-- Populated with available rooms -->
        </div>
        <button type="button" class="btn neutral" onclick="closeModal('joinRoomModal')">Schließen</button>
    </div>
</div>

<!-- Password Entry Modal -->
<div class="modal" id="passwordModal">
    <div class="modal-content">
        <h3>🔐 Passwort eingeben</h3>
        <form id="passwordForm">
            <input type="hidden" name="roomId">
            <input type="password" name="password" placeholder="Raumpasswort" required>
            <div class="modal-actions">
                <button type="submit" class="btn">Beitreten</button>
                <button type="button" class="btn neutral" onclick="closeModal('passwordModal')">Abbrechen</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Message Modal -->
<div class="modal" id="deleteMessageModal">
    <div class="modal-content">
        <h3>🗑️ Nachricht löschen</h3>
        <p>Sind Sie sicher, dass Sie diese Nachricht löschen möchten?</p>
        <div class="message-preview" id="deleteMessagePreview"></div>
        <div class="modal-actions">
            <button type="button" class="btn danger" id="confirmDeleteBtn">Löschen</button>
            <button type="button" class="btn neutral" onclick="closeModal('deleteMessageModal')">Abbrechen</button>
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div class="modal" id="editMessageModal">
    <div class="modal-content">
        <h3>✏️ Nachricht bearbeiten</h3>
        <form id="editMessageForm">
            <input type="hidden" id="editMessageId">
            <textarea id="editMessageText" placeholder="Nachricht bearbeiten..." required maxlength="3000" rows="4"></textarea>
            <div class="char-counter">
                <span id="editCharCount">0</span>/3000 Zeichen
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn">Speichern</button>
                <button type="button" class="btn neutral" onclick="closeModal('editMessageModal')">Abbrechen</button>
            </div>
        </form>
    </div>
</div>

<!-- Chat Settings Modal -->
<div class="modal" id="chatSettingsModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>⚙️ Chat Settings</h3>
        <div class="settings-grid">
            <div class="setting-group">
                <label>📝 Normale Textfarbe</label>
                <input type="color" id="normalTextColor" value="#e9eef3">
            </div>

            <div class="setting-group">
                <label>💬 „Sprechen" Textfarbe (Anführungszeichen)</label>
                <input type="color" id="quoteTextColor" value="#4ec9b0">
            </div>

            <div class="setting-group">
                <label>📏 Schriftgröße</label>
                <input type="range" id="fontSize" min="10" max="24" value="14">
                <span id="fontSizeValue">14px</span>
            </div>

            <div class="setting-group">
                <label>🔤 Schriftart</label>
                <select id="fontFamily">
                    <option value="Inter, 'Segoe UI', Arial, sans-serif">Standard (Inter)</option>
                    <option value="'Arial', sans-serif">Arial</option>
                    <option value="'Helvetica', Arial, sans-serif">Helvetica</option>
                    <option value="'Verdana', sans-serif">Verdana</option>
                    <option value="'Calibri', sans-serif">Calibri</option>
                    <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                    <option value="'Tahoma', sans-serif">Tahoma</option>
                    <option value="'Lucida Sans', sans-serif">Lucida Sans</option>
                    <option value="'Segoe UI', sans-serif">Segoe UI</option>
                    <option value="'Times New Roman', serif">Times New Roman</option>
                    <option value="'Georgia', serif">Georgia</option>
                    <option value="'Book Antiqua', serif">Book Antiqua</option>
                    <option value="'Garamond', serif">Garamond</option>
                    <option value="'Palatino', serif">Palatino</option>
                    <option value="'Times', serif">Times</option>
                    <option value="'Courier New', monospace">Courier New</option>
                    <option value="'Monaco', monospace">Monaco</option>
                    <option value="'Consolas', monospace">Consolas</option>
                    <option value="'Lucida Console', monospace">Lucida Console</option>
                    <option value="'Source Code Pro', monospace">Source Code Pro</option>
                    <option value="'Fira Code', monospace">Fira Code</option>
                    <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
                    <option value="'Cascadia Code', monospace">Cascadia Code</option>
                    <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                    <option value="'Brush Script MT', cursive">Brush Script MT</option>
                    <option value="'Papyrus', fantasy">Papyrus</option>
                    <option value="'Impact', fantasy">Impact</option>
                    <option value="'Chiller', fantasy">Chiller</option>
                    <option value="'Bebas Neue', sans-serif">Bebas Neue</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Poppins', sans-serif">Poppins</option>
                    <option value="'Oswald', sans-serif">Oswald</option>
                    <option value="'Nunito', sans-serif">Nunito</option>
                    <option value="'Raleway', sans-serif">Raleway</option>
                    <option value="'Ubuntu', sans-serif">Ubuntu</option>
                    <option value="'Quicksand', sans-serif">Quicksand</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="'Merriweather', serif">Merriweather</option>
                    <option value="'Lora', serif">Lora</option>
                    <option value="'PT Serif', serif">PT Serif</option>
                    <option value="'Crimson Text', serif">Crimson Text</option>
                    <option value="system-ui, -apple-system, sans-serif">System UI</option>
                    <option value="-apple-system, BlinkMacSystemFont, sans-serif">Apple System</option>
                    <option value="'SF Pro Display', -apple-system, sans-serif">SF Pro Display</option>
                    <option value="'Segoe UI Variable', 'Segoe UI', sans-serif">Segoe UI Variable</option>
                </select>
            </div>

            <div class="setting-group preview-group">
                <label>👁️ Vorschau</label>
                <div class="message-preview" id="messagePreview">
                    <div class="message-content">
                        Das ist ein normaler Text. „Das ist gesprochener Text in deutschen Anführungszeichen."
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn" id="saveSettings">💾 Speichern</button>
            <button type="button" class="btn neutral" id="resetSettings">🔄 Zurücksetzen</button>
            <button type="button" class="btn neutral" onclick="closeModal('chatSettingsModal')">Schließen</button>
        </div>
    </div>
</div>

<!-- Lightbox -->
<div class="modal" id="imgModal">
    <button class="close-x">Schließen</button>
    <img src="" alt="Vorschau">
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(() => {
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2,9);

    const SAVE_PREFIX = 'RPS-';
    const SAVE_EXT = '.json';
    const IMG_EXT = '.png';

    const tabsRoot = $('#tabs');
    const panelsRoot = $('#panels');

    let tabs = [];
    let current = null;
    let currentUser = {{ current_user.to_dict() | tojson if current_user.is_authenticated else 'null' }};

    // Authentication toggle functionality
    const showRegister = $('#showRegister');
    const showLogin = $('#showLogin');
    const loginForm = $('#loginForm');
    const registerForm = $('#registerForm');

    if (showRegister) {
        showRegister.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        });
    }

    if (showLogin) {
        showLogin.addEventListener('click', () => {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });
    }

    // File loader and drag-drop
    $('#fileLoader').addEventListener('change', (e) => {
        const files = Array.from(e.target.files || []);
        loadFiles(files);
        e.target.value = '';
    });

    const drop = $('#dropzone');
    ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e) => {
        e.preventDefault();
        drop.classList.add('drag');
    }));
    ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, (e) => {
        e.preventDefault();
        drop.classList.remove('drag');
    }));
    drop.addEventListener('drop', (e) => {
        const files = Array.from(e.dataTransfer.files || []);
        loadFiles(files);
    });

    $('#btnNew').addEventListener('click', () => createCharacterTab());

    // Lightbox
    const modal = $('#imgModal');
    modal.addEventListener('click', (e) => {
        if (e.target === modal || e.target.classList.contains('close-x'))
            modal.classList.remove('open');
    });

    // Initialize with first character
    createCharacterTab("Charakter 1");

    // File loading functions
    async function loadFiles(files) {
        for (const file of files) {
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                const title = data.name?.trim() ||
                    (file.name.startsWith(SAVE_PREFIX) ?
                        file.name.slice(SAVE_PREFIX.length).replace(/\.json$/, '') :
                        file.name.replace(/\.(json|txt)$/, ''));
                const id = createCharacterTab(title, false);
                const panel = $(`.panel[data-id="${id}"]`, panelsRoot);
                setPanelData(panel, data);
            } catch(err) {
                alert(`Konnte ${file.name} nicht laden.`);
            }
        }
        if (tabs.length) activateTab(tabs[tabs.length-1].id);
    }

    // Tab management
    function createCharacterTab(title, activateNow = true) {
        const id = uid();
        const index = tabs.length;
        const t = { id, title: title || `Charakter ${index+1}`, type:'character' };
        tabs.push(t);

        const tabEl = document.createElement('div');
        tabEl.className = 'tab';
        tabEl.dataset.id = id;
        tabEl.innerHTML = `
            <span class="title">${t.title}</span>
            <button class="share-char" title="Charakter teilen">📤</button>
            <button class="close" title="Tab schließen">×</button>
        `;
        tabsRoot.insertBefore(tabEl, $('#btnNew'));

        tabEl.addEventListener('click', (e) => {
            if (e.target.closest('.close') || e.target.closest('.share-char')) return;
            activateTab(id);
        });

        tabEl.querySelector('.close').addEventListener('click', (e) => {
            e.stopPropagation();
            closeTab(id);
        });

        tabEl.querySelector('.share-char').addEventListener('click', (e) => {
            e.stopPropagation();
            shareCharacterToChat(id);
        });

        const panel = document.createElement('div');
        panel.className = 'panel';
        panel.dataset.id = id;
        panel.innerHTML = panelTemplate(id);
        panelsRoot.appendChild(panel);

        wireCharacterPanel(panel);

        if(activateNow) activateTab(id);
        return id;
    }

    function closeTab(id) {
        const tabEl = document.querySelector(`.tab[data-id="${id}"]`);
        const panelEl = document.querySelector(`.panel[data-id="${id}"]`);
        const idx = tabs.findIndex(t => t.id === id);
        if (tabEl) tabEl.remove();
        if (panelEl) panelEl.remove();
        if (idx !== -1) tabs.splice(idx,1);

        if (current === id) {
            const next = tabs[0];
            if (next) activateTab(next.id);
        }
    }

    function activateTab(id) {
        $$('.tab', tabsRoot).forEach(el => el.classList.toggle('active', el.dataset.id === id));
        $$('.panel', panelsRoot).forEach(el => el.classList.toggle('active', el.dataset.id === id));
        current = id;
        recalcEffective(getActivePanel());
    }

    function getActivePanel() {
        return $(`.panel.active`, panelsRoot);
    }

    // Panel template
    function panelTemplate(id) {
        const signGroup = `sign-${id}`;
        return `
            <div class="grid">
                <div class="card">
                    <h3>👤 Charakter</h3>
                    <label>Name</label>
                    <input type="text" class="name" placeholder="Charaktername">

                    <h3>💪 Basis Attribute</h3>

                    <div class="row">
                        <div class="attr-str">
                            <label>💪 STR</label>
                            <div class="attr-input">
                                <input type="number" class="staerke" value="0" min="1" max="10">
                                <div class="progress-bar"><div class="progress-fill"></div></div>
                            </div>
                        </div>
                        <div class="attr-dex">
                            <label>🤸 GES</label>
                            <div class="attr-input">
                                <input type="number" class="geschick" value="0" min="1" max="10">
                                <div class="progress-bar"><div class="progress-fill"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="attr-per">
                            <label>👁️ WAH</label>
                            <div class="attr-input">
                                <input type="number" class="wahrnehmung" value="0" min="1" max="10">
                                <div class="progress-bar"><div class="progress-fill"></div></div>
                            </div>
                        </div>
                        <div class="attr-wil">
                            <label>🧠 WIL</label>
                            <div class="attr-input">
                                <input type="number" class="willenskraft" value="0" min="1" max="10">
                                <div class="progress-bar"><div class="progress-fill"></div></div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <h4>📊 Wert Modifikatoren</h4>
                        <div class="eff-grid">
                            <div class="eff attr-str"><div class="label">💪</div><div class="val eff-str">0</div></div>
                            <div class="eff attr-dex"><div class="label">🤸</div><div class="val eff-dex">0</div></div>
                            <div class="eff attr-per"><div class="label">👁️</div><div class="val eff-per">0</div></div>
                            <div class="eff attr-wil"><div class="label">🧠</div><div class="val eff-wil">0</div></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>⚡ Zustände</h3>
                    <label>Beschreibung</label>
                    <input type="text" class="zustand-text" placeholder="z. B. Rechte Hand verletzt">

                    <div class="row">
                        <div>
                            <label>Attribut</label>
                            <select class="zustand-attr">
                                <option>Stärke</option>
                                <option>Geschicklichkeit</option>
                                <option>Wahrnehmung</option>
                                <option>Willenskraft</option>
                            </select>
                        </div>
                        <div>
                            <label>Wert</label>
                            <div class="controls mt-4">
                                <label><input type="radio" name="${signGroup}" value="+" checked> +</label>
                                <label><input type="radio" name="${signGroup}" value="-"> −</label>
                                <input type="number" class="zustand-value w-80" value="1">
                            </div>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-add-zustand" type="button">⚡ Zustand hinzufügen</button>
                    </div>

                    <div class="zustaende-container">
                        <ul class="list zustaende"></ul>
                    </div>
                </div>

                <div class="card">
                    <div class="image-section">
                        <div class="image-top">
                            <h4>🖼️ Charakterbild</h4>
                            <div class="img-wrap flex-column align-center">
                                <img class="img-preview w-320 h-320 mb-4" alt="Vorschau" src="" title="Zum Vergrößern klicken">
                                <div class="w-100 text-center">
                                    <label class="font-12">Bild auswählen</label>
                                    <input type="file" class="img-file font-12" accept="image/png,image/jpeg">
                                    <div class="img-name tiny font-11"></div>
                                    <div class="tiny font-10">RPS-{Name}.png</div>
                                </div>
                            </div>
                        </div>
                        <div class="image-bottom">
                            <div class="actions mt-2 justify-content-center">
                                <button class="btn btn-save-img font-12 padding-6-8" disabled type="button">💾 PNG speichern</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 16px;">
                <h3>🎲 Würfeln</h3>
                <div class="dice-wrap">
                    <div class="dice-left">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding-bottom: 12px;">
                            <button class="btn attr-btn attr-str" data-attr="Stärke" type="button">💪 STR</button>
                            <button class="btn attr-btn attr-dex" data-attr="Geschicklichkeit" type="button">🤸 GES</button>
                            <button class="btn attr-btn attr-per" data-attr="Wahrnehmung" type="button">👁️ WAH</button>
                            <button class="btn attr-btn attr-wil" data-attr="Willenskraft" type="button">🧠 WIL</button>
                        </div>
                        <div class="current-attr text-center" style="padding-bottom: 12px; font-size: 14px; color: var(--muted);">Wähle ein Attribut zum Würfeln</div>
                        <button class="btn-roll-big" type="button">🎲 WÜRFELN</button>
                    </div>

                    <div class="dice-panel">
                        <div class="dice-big">—</div>
                        <div class="dice-breakdown">Noch kein Wurf.</div>
                        <div class="history">
                            <h4>Historie (letzte 10)</h4>
                            <ul class="history-list"></ul>
                        </div>
                    </div>

                    <div class="actions" style="margin-top: 16px; justify-content: center;">
                        <button class="btn neutral btn-save-json" type="button">💾 Speichern (JSON)</button>
                        <button class="btn btn-save-server" type="button">☁️ Speichern (Server)</button>
                    </div>
                </div>
            </div>
        `;
    }

    // Panel wiring functions
    function wireCharacterPanel(panel) {
        // Name updates tab title
        const nameInput = panel.querySelector('.name');
        nameInput.addEventListener('input', () => {
            const tabTitle = document.querySelector(`.tab[data-id="${panel.dataset.id}"] .title`);
            const newName = nameInput.value.trim() || defaultTabTitle(panel.dataset.id);
            tabTitle.textContent = newName;
            updateImgNameHint(panel);
        });

        // Attribute live updates
        ['staerke','geschick','wahrnehmung','willenskraft'].forEach(cls => {
            const el = panel.querySelector(`.${cls}`);
            el.addEventListener('input', () => recalcEffective(panel));
        });

        // Add state
        panel.querySelector('.btn-add-zustand').addEventListener('click', () => {
            const text = panel.querySelector('.zustand-text').value.trim();
            const attr = panel.querySelector('.zustand-attr').value;
            const val = parseInt(panel.querySelector('.zustand-value').value || '0', 10);
            const signName = panel.querySelector('[type="radio"]').name;
            const sign = panel.querySelector(`input[name="${signName}"]:checked`).value;

            if(!text) { alert('Bitte eine Beschreibung eingeben.'); return; }
            if(!val || val === 0) { alert('Wert darf nicht 0 sein.'); return; }

            const li = document.createElement('li');
            li.dataset.attr = attr;
            li.dataset.sign = sign;
            li.dataset.value = String(val);
            li.dataset.active = 'true';
            li.innerHTML = `
                <div>
                    <strong>${attr} ${sign}${val}</strong> <span class="pill">(${text})</span>
                </div>
                <div class="controls">
                    <label><input type="checkbox" class="toggle" checked> aktiv</label>
                    <span class="remove" title="Entfernen">Entfernen</span>
                </div>
            `;
            li.querySelector('.toggle').addEventListener('change', (e) => {
                li.dataset.active = e.target.checked ? 'true' : 'false';
                recalcEffective(panel);
            });
            li.querySelector('.remove').addEventListener('click', () => {
                li.remove();
                recalcEffective(panel);
            });

            panel.querySelector('.zustaende').appendChild(li);
            panel.querySelector('.zustand-text').value = '';
            panel.querySelector('.zustand-value').value = 1;
            recalcEffective(panel);
        });

        // Save functions
        panel.querySelector('.btn-save-json').addEventListener('click', () => {
            const data = getPanelData(panel);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)], {type:'application/json'}));
            a.download = (data.name?.trim() ? SAVE_PREFIX + data.name.trim() : SAVE_PREFIX + defaultTabTitle(panel.dataset.id)) + SAVE_EXT;
            a.click();
        });

        panel.querySelector('.btn-save-server').addEventListener('click', async () => {
            await saveCharacterToServer(panel);
        });

        // Dice rolling
        panel.querySelectorAll('.attr-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                panel.querySelectorAll('.attr-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const attrName = btn.dataset.attr;
                const currentAttr = panel.querySelector('.current-attr');
                currentAttr.textContent = `Gewählt: ${attrName}`;
            });
        });

        panel.querySelector('.btn-roll-big').addEventListener('click', () => {
            const activeBtn = panel.querySelector('.attr-btn.active');
            if (!activeBtn) {
                alert('Bitte wähle zuerst ein Attribut aus!');
                return;
            }
            const attr = activeBtn.dataset.attr;
            rollDice(panel, attr);
        });

        // Image handling
        const imgFile = panel.querySelector('.img-file');
        const imgPreview = panel.querySelector('.img-preview');
        const btnSaveImg = panel.querySelector('.btn-save-img');

        imgFile.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                imgPreview.src = reader.result;
                btnSaveImg.disabled = false;
                panel.dataset.imageData = reader.result;
            };
            reader.readAsDataURL(file);
        });

        imgPreview.addEventListener('click', () => {
            if (imgPreview.src) {
                modal.querySelector('img').src = imgPreview.src;
                modal.classList.add('open');
            }
        });

        btnSaveImg.addEventListener('click', () => {
            if (!panel.dataset.imageData) return;
            const a = document.createElement('a');
            a.href = panel.dataset.imageData;
            const name = panel.querySelector('.name').value.trim() || defaultTabTitle(panel.dataset.id);
            a.download = buildImageName(name);
            a.click();
        });
    }

    // Helper functions
    function defaultTabTitle(id) {
        const index = tabs.findIndex(t => t.id === id);
        return `Charakter ${index + 1}`;
    }

    function buildImageName(charName) {
        return `${SAVE_PREFIX}${charName.replace(/[^a-zA-Z0-9äöüßÄÖÜ\s-]/g, '').replace(/\s+/g, '_')}${IMG_EXT}`;
    }

    function updateImgNameHint(panel) {
        const nameHint = panel.querySelector('.img-name');
        const name = panel.querySelector('.name').value.trim() || defaultTabTitle(panel.dataset.id);
        nameHint.textContent = buildImageName(name);
    }

    function recalcEffective(panel) {
        if (!panel) return;

        const base = {
            str: parseInt(panel.querySelector('.staerke')?.value || '0', 10),
            dex: parseInt(panel.querySelector('.geschick')?.value || '0', 10),
            per: parseInt(panel.querySelector('.wahrnehmung')?.value || '0', 10),
            wil: parseInt(panel.querySelector('.willenskraft')?.value || '0', 10)
        };

        updateProgressBar(panel, '.staerke', base.str);
        updateProgressBar(panel, '.geschick', base.dex);
        updateProgressBar(panel, '.wahrnehmung', base.per);
        updateProgressBar(panel, '.willenskraft', base.wil);

        const eff = { ...base };

        // Apply state modifications
        const states = panel.querySelectorAll('.zustaende li[data-active="true"]');
        states.forEach(state => {
            const attr = state.dataset.attr;
            const sign = state.dataset.sign;
            const val = parseInt(state.dataset.value || '0', 10);
            const mod = sign === '+' ? val : -val;

            if (attr === 'Stärke') eff.str += mod;
            else if (attr === 'Geschicklichkeit') eff.dex += mod;
            else if (attr === 'Wahrnehmung') eff.per += mod;
            else if (attr === 'Willenskraft') eff.wil += mod;
        });

        Object.keys(eff).forEach(k => eff[k] = Math.max(0, eff[k]));

        panel.querySelector('.eff-str').textContent = eff.str;
        panel.querySelector('.eff-dex').textContent = eff.dex;
        panel.querySelector('.eff-per').textContent = eff.per;
        panel.querySelector('.eff-wil').textContent = eff.wil;
    }

    function updateProgressBar(panel, selector, value) {
        const input = panel.querySelector(selector);
        if (!input) return;

        const progressBar = input.parentElement.querySelector('.progress-fill');
        if (!progressBar) return;

        const percentage = Math.min(100, (value / 10) * 100);
        progressBar.style.width = `${percentage}%`;
    }

    function rollDice(panel, attr) {
        const attrMapping = {
            'Stärke': 'eff-str',
            'Geschicklichkeit': 'eff-dex',
            'Wahrnehmung': 'eff-per',
            'Willenskraft': 'eff-wil'
        };

        const roll = Math.floor(Math.random() * 20) + 1;
        const effValue = parseInt(panel.querySelector(`.${attrMapping[attr]}`).textContent || '0', 10);
        const totalValue = roll + effValue;

        let result, cssClass, displayValue;
        if (roll === 20) {
            result = 'Kritischer Erfolg!';
            cssClass = 'crit-success';
            displayValue = totalValue;
        } else if (roll === 1) {
            result = 'Kritischer Fehler!';
            cssClass = 'crit-fail';
            displayValue = totalValue;
        } else {
            result = 'Erfolg';
            cssClass = 'neutral';
            displayValue = totalValue;
        }

        const diceDisplay = panel.querySelector('.dice-big');
        const breakdown = panel.querySelector('.dice-breakdown');

        diceDisplay.textContent = displayValue;
        diceDisplay.className = `dice-big ${cssClass}`;
        breakdown.textContent = `${attr} ${effValue} → ${result}`;

        // Add to history
        const historyList = panel.querySelector('.history-list');
        const historyItem = document.createElement('li');
        historyItem.textContent = `W20=${roll}+${effValue}=${totalValue} → ${result}`;
        historyList.insertBefore(historyItem, historyList.firstChild);

        while (historyList.children.length > 10) {
            historyList.removeChild(historyList.lastChild);
        }

        // Send dice roll to chat if chat is open
        sendDiceRollToChat(panel, attr, roll, effValue, totalValue);
    }

    function sendDiceRollToChat(panel, attribute, rollValue, modifier, total) {
        // Check if user is in a chat room
        const activeRoom = localStorage.getItem('activeRoom');
        if (!activeRoom) return;

        // Get character name from panel
        const characterName = panel.querySelector('.name').value.trim();
        if (!characterName) return;

        // Map German attribute names to short codes for display
        const attrDisplayMapping = {
            'Stärke': 'STR',
            'Geschicklichkeit': 'GES',
            'Wahrnehmung': 'WAH',
            'Willenskraft': 'WIL'
        };

        // Send dice roll to chat
        fetch(`/api/chat/rooms/${activeRoom}/dice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                character_name: characterName,
                attribute: attrDisplayMapping[attribute] || attribute,
                roll_value: rollValue,
                modifier: modifier,
                total: total
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Dice roll sent to chat');
                // Refresh chat messages if chat panel is visible
                if (typeof refreshChatMessages === 'function') {
                    refreshChatMessages();
                }
            }
        })
        .catch(error => {
            console.error('Error sending dice roll to chat:', error);
        });
    }

    function getPanelData(panel) {
        const states = Array.from(panel.querySelectorAll('.zustaende li')).map(li => ({
            description: li.querySelector('.pill').textContent.replace(/[()]/g, ''),
            attr: li.dataset.attr,
            sign: li.dataset.sign,
            value: parseInt(li.dataset.value || '0', 10),
            active: li.dataset.active === 'true'
        }));

        return {
            name: panel.querySelector('.name').value.trim(),
            staerke: parseInt(panel.querySelector('.staerke').value || '0', 10),
            geschicklichkeit: parseInt(panel.querySelector('.geschick').value || '0', 10),
            wahrnehmung: parseInt(panel.querySelector('.wahrnehmung').value || '0', 10),
            willenskraft: parseInt(panel.querySelector('.willenskraft').value || '0', 10),
            zustaende: states,
            imageData: panel.dataset.imageData || null
        };
    }

    function setPanelData(panel, data) {
        // Store character ID for updates
        if (data.id) {
            panel.dataset.characterId = data.id;
        }

        panel.querySelector('.name').value = data.name || '';
        panel.querySelector('.staerke').value = data.staerke || 0;
        panel.querySelector('.geschick').value = data.geschicklichkeit || 0;
        panel.querySelector('.wahrnehmung').value = data.wahrnehmung || 0;
        panel.querySelector('.willenskraft').value = data.willenskraft || 0;

        // Set current health and stress if available
        const lebenInput = panel.querySelector('.leben');
        if (lebenInput && data.aktuelles_leben !== undefined) {
            lebenInput.value = data.aktuelles_leben;
        }

        const stressInput = panel.querySelector('.stress');
        if (stressInput && data.aktueller_stress !== undefined) {
            stressInput.value = data.aktueller_stress;
        }

        if (data.imageData) {
            console.log('Setting panel image data:', data.imageData ? 'Yes (' + data.imageData.length + ' chars)' : 'No');
            const imageData = data.imageData.startsWith('data:') ? data.imageData : `data:image/png;base64,${data.imageData}`;
            panel.dataset.imageData = imageData;
            const imgPreview = panel.querySelector('.img-preview');
            if (imgPreview) {
                imgPreview.src = imageData;
                imgPreview.style.display = 'block';
                console.log('Image preview updated');
            } else {
                console.log('Image preview element not found');
            }
            const btnSaveImg = panel.querySelector('.btn-save-img');
            if (btnSaveImg) {
                btnSaveImg.disabled = false;
            }
        } else {
            console.log('No image data to set');
        }

        const zustaendeList = panel.querySelector('.zustaende');
        zustaendeList.innerHTML = '';
        (data.zustaende || []).forEach(state => {
            const li = document.createElement('li');
            li.dataset.attr = state.attr;
            li.dataset.sign = state.sign;
            li.dataset.value = String(state.value);
            li.dataset.active = String(state.active);

            li.innerHTML = `
                <div>
                    <strong>${state.attr} ${state.sign}${state.value}</strong> <span class="pill">(${state.description})</span>
                </div>
                <div class="controls">
                    <label><input type="checkbox" class="toggle" ${state.active ? 'checked' : ''}> aktiv</label>
                    <span class="remove" title="Entfernen">Entfernen</span>
                </div>
            `;

            li.querySelector('.toggle').addEventListener('change', (e) => {
                li.dataset.active = e.target.checked ? 'true' : 'false';
                recalcEffective(panel);
            });
            li.querySelector('.remove').addEventListener('click', () => {
                li.remove();
                recalcEffective(panel);
            });

            zustaendeList.appendChild(li);
        });

        updateImgNameHint(panel);
        recalcEffective(panel);
    }

    // Server functions
    async function saveCharacterToServer(panel) {
        if (!currentUser) {
            alert('Sie müssen eingeloggt sein, um Charaktere zu speichern.');
            return;
        }

        const data = getPanelData(panel);

        try {
            const response = await fetch('/api/characters', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: data.name,
                    staerke: data.staerke,
                    geschicklichkeit: data.geschicklichkeit,
                    wahrnehmung: data.wahrnehmung,
                    willenskraft: data.willenskraft,
                    zustaende: data.zustaende,
                    image_base64: data.imageData
                })
            });

            if (response.ok) {
                alert('Charakter erfolgreich gespeichert!');
                location.reload();
            } else {
                const error = await response.json();
                alert(`Fehler beim Speichern: ${error.message}`);
            }
        } catch (err) {
            alert('Netzwerkfehler beim Speichern des Charakters.');
            console.error(err);
        }
    }

    function shareCharacterToChat(tabId) {
        const panel = document.querySelector(`.panel[data-id="${tabId}"]`);
        if (!panel) return;
        const data = getPanelData(panel);
        console.log('Sharing character to chat:', data);
        alert('Chat-Funktion noch nicht implementiert');
    }

    // Character management from sidebar
    window.loadCharacter = async function(charId) {
        try {
            const response = await fetch(`/api/characters/${charId}`);
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    const char = result.character;
                    console.log('Loading character:', char);
                    console.log('Image data received:', char.image_base64 ? 'Yes (' + (char.image_base64.length) + ' chars)' : 'No');

                    const tabId = createCharacterTab(char.name, true);
                    const panel = document.querySelector(`.panel[data-id="${tabId}"]`);
                    setPanelData(panel, {
                        id: char.id,
                        name: char.name,
                        staerke: char.staerke,
                        geschicklichkeit: char.geschicklichkeit,
                        wahrnehmung: char.wahrnehmung,
                        willenskraft: char.willenskraft,
                        aktuelles_leben: char.aktuelles_leben,
                        aktueller_stress: char.aktueller_stress,
                        zustaende: char.zustaende || [],
                        effekte: char.effekte || [],
                        imageData: char.image_base64
                    });
                    console.log('Character loaded successfully:', char.name);
                } else {
                    alert('Fehler: ' + result.message);
                }
            } else {
                alert('Fehler beim Laden des Charakters (HTTP ' + response.status + ')');
            }
        } catch (err) {
            console.error('Error loading character:', err);
            alert('Fehler beim Laden des Charakters.');
        }
    }

    window.deleteCharacter = async function(charId) {
        if (!confirm('Charakter wirklich löschen?')) return;
        try {
            const response = await fetch(`/api/characters/${charId}`, { method: 'DELETE' });
            if (response.ok) {
                location.reload();
            } else {
                alert('Fehler beim Löschen des Charakters.');
            }
        } catch (err) {
            alert('Netzwerkfehler beim Löschen.');
        }
    };

    // Chat System Implementation
    class ChatManager {
        constructor() {
            this.activeRoom = null;
            this.rooms = [];
            this.messages = new Map();
            this.members = new Map();
            this.pollInterval = null;
            this.lastMessageId = new Map();

            this.initEventListeners();
            this.loadUserRooms();
            this.loadChatSettings();
        }

        initEventListeners() {
            console.log('Initializing event listeners...');

            // Modal controls
            const createBtn = $('#createRoomBtn');
            const joinBtn = $('#joinRoomBtn');
            const memberBtn = $('#memberListBtn');

            if (createBtn) {
                createBtn.addEventListener('click', () => {
                    console.log('Create room button clicked');
                    this.showCreateRoomModal();
                });
            } else console.error('Create room button not found');

            if (joinBtn) {
                joinBtn.addEventListener('click', () => this.showJoinRoomModal());
            } else console.error('Join room button not found');

            if (memberBtn) {
                memberBtn.addEventListener('click', () => this.toggleMemberSidebar());
            } else console.error('Member list button not found');

            const closeMemberBtn = $('#closeMemberBtn');
            if (closeMemberBtn) {
                closeMemberBtn.addEventListener('click', () => this.toggleMemberSidebar());
            }

            const settingsBtn = $('#chatSettingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => this.showChatSettings());
            } else console.error('Chat settings button not found');

            // Form submissions
            const createForm = $('#createRoomForm');
            const passwordForm = $('#passwordForm');
            const editMessageForm = $('#editMessageForm');
            const confirmDeleteBtn = $('#confirmDeleteBtn');
            const editMessageText = $('#editMessageText');

            if (createForm) {
                createForm.addEventListener('submit', (e) => {
                    console.log('Form submit event triggered');
                    this.handleCreateRoom(e);
                });

                // Also add direct button listener as backup
                const submitBtn = $('#createRoomSubmit');
                if (submitBtn) {
                    submitBtn.addEventListener('click', (e) => {
                        console.log('Submit button clicked directly');
                        e.preventDefault();
                        this.handleCreateRoom(e);
                    });
                }
            } else console.error('Create room form not found');

            if (passwordForm) {
                passwordForm.addEventListener('submit', (e) => {
                    this.handlePasswordSubmit(e);
                });

                // Also add a click event to the submit button as backup
                const submitBtn = passwordForm.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const form = e.target.closest('form');
                        if (form) {
                            const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                            form.dispatchEvent(submitEvent);
                        }
                    });
                }
            } else {
                console.error('Password form not found');
            }

            // Message modal handlers
            if (editMessageForm) {
                editMessageForm.addEventListener('submit', (e) => this.handleEditMessageSubmit(e));

                // Also add direct button click handler as backup
                const editSubmitBtn = editMessageForm.querySelector('button[type="submit"]');
                if (editSubmitBtn) {
                    editSubmitBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const form = e.target.closest('form');
                        if (form) {
                            const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                            form.dispatchEvent(submitEvent);
                        }
                    });
                }
            }

            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', () => this.handleConfirmDelete());
            }

            if (editMessageText) {
                editMessageText.addEventListener('input', (e) => this.updateCharCount(e));
            }

            // Private room checkbox
            const privateCheck = $('#isPrivateCheck');
            if (privateCheck) {
                privateCheck.addEventListener('change', (e) => {
                    const passwordField = $('#roomPassword');
                    if (passwordField) {
                        passwordField.classList.toggle('hidden', !e.target.checked);
                        passwordField.required = e.target.checked;
                    }
                });
            }

            // Chat input
            const chatInput = $('#chatInput');
            const sendBtn = $('#sendBtn');
            const shareBtn = $('#shareCharBtn');

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }

            if (sendBtn) {
                sendBtn.addEventListener('click', () => this.sendMessage());
            }

            if (shareBtn) {
                shareBtn.addEventListener('click', () => this.shareCurrentCharacter());
            }

            // Chat Settings Event Listeners
            const saveSettingsBtn = $('#saveSettings');
            const resetSettingsBtn = $('#resetSettings');
            const fontSizeSlider = $('#fontSize');
            const fontSizeValue = $('#fontSizeValue');

            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => this.saveChatSettings());
            }

            if (resetSettingsBtn) {
                resetSettingsBtn.addEventListener('click', () => this.resetChatSettings());
            }

            if (fontSizeSlider && fontSizeValue) {
                fontSizeSlider.addEventListener('input', (e) => {
                    fontSizeValue.textContent = e.target.value + 'px';
                    this.updatePreview();
                });
            }

            // Preview update listeners
            ['normalTextColor', 'quoteTextColor', 'fontFamily'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => this.updatePreview());
                }
            });

            console.log('Event listeners initialized');
        }

        async loadUserRooms() {
            try {
                const response = await fetch('/api/chat/rooms');
                if (response.ok) {
                    const data = await response.json();
                    this.rooms = data.rooms;
                    this.renderRoomTabs();
                }
            } catch (err) {
                console.error('Error loading rooms:', err);
            }
        }

        renderRoomTabs() {
            const container = $('#chatRoomTabs');
            container.innerHTML = '';

            this.rooms.forEach(room => {
                const tab = document.createElement('div');
                tab.className = `chat-room-tab ${this.activeRoom === room.id ? 'active' : ''}`;
                tab.innerHTML = `
                    <span>${room.name} ${room.has_password ? '🔒' : ''}</span>
                    <button class="close-tab" onclick="chatManager.leaveRoom(${room.id})">&times;</button>
                `;
                tab.addEventListener('click', (e) => {
                    if (e.target.classList.contains('close-tab')) return;
                    this.switchToRoom(room.id);
                });
                container.appendChild(tab);
            });
        }

        async switchToRoom(roomId) {
            if (this.activeRoom === roomId) return;

            const room = this.rooms.find(r => r.id === roomId);
            if (!room) return;

            // Try to load messages first to check access
            try {
                const response = await fetch(`/api/chat/rooms/${roomId}/messages`);
                if (response.status === 403) {
                    // User is not a member - show password prompt if room has password
                    if (room.has_password) {
                        this.showPasswordModal(roomId);
                        return;
                    } else {
                        // Public room - try to join automatically
                        await this.joinRoom(roomId);
                        return;
                    }
                } else if (!response.ok) {
                    alert('Fehler beim Zugriff auf den Raum');
                    return;
                }

                // Success - user has access
                this.activeRoom = roomId;
                $('#activeRoomName').textContent = room.name;
                $('#chatInput').disabled = false;
                $('#sendBtn').disabled = false;
                $('#shareCharBtn').disabled = false;

                this.renderRoomTabs();
                await this.loadRoomMessages(roomId);
                await this.loadRoomMembers(roomId);
                this.startPolling();

            } catch (err) {
                console.error('Error checking room access:', err);
                alert('Fehler beim Zugriff auf den Raum');
            }
        }

        async loadRoomMessages(roomId) {
            try {
                const response = await fetch(`/api/chat/rooms/${roomId}/messages`);
                if (response.ok) {
                    const data = await response.json();
                    this.messages.set(roomId, data.messages);
                    this.renderMessages();
                    if (data.messages.length > 0) {
                        this.lastMessageId.set(roomId, data.messages[data.messages.length - 1].id);
                    }
                }
            } catch (err) {
                console.error('Error loading messages:', err);
            }
        }

        renderMessages() {
            const container = $('#chatMessages');
            const messages = this.messages.get(this.activeRoom) || [];

            if (messages.length === 0) {
                container.innerHTML = '<div class="chat-placeholder">Noch keine Nachrichten...</div>';
                return;
            }

            // Build HTML string directly with processed quotes
            let html = '';
            messages.forEach(msg => {
                const isOwn = msg.user_id === {{ current_user.id if current_user.is_authenticated else 'null' }};
                const timestamp = new Date(msg.timestamp).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});

                // Use the unified formatMessageText function
                let messageText = this.formatMessageText(msg.message);


                html += `
                    <div class="message ${isOwn ? 'own' : ''}" data-message-id="${msg.id}">
                        <div class="message-header">
                            <span>${msg.username}</span>
                            <span>${timestamp}</span>
                            ${isOwn ? `
                                <div class="message-actions">
                                    <button class="btn-message-edit" onclick="chatManager.editMessage(${msg.id})" title="Bearbeiten">✏️</button>
                                    <button class="btn-message-delete" onclick="chatManager.deleteMessage(${msg.id})" title="Löschen">🗑️</button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="message-content">${messageText}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        renderMessage(msg) {
            const isOwn = msg.user_id === {{ current_user.id if current_user.is_authenticated else 'null' }};
            const timestamp = new Date(msg.timestamp).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});

            return `
                <div class="message ${isOwn ? 'own' : ''}" data-message-id="${msg.id}">
                    <div class="message-header">
                        <span>${msg.username}</span>
                        <span>${timestamp}</span>
                        ${isOwn ? `
                            <div class="message-actions">
                                <button class="btn-message-edit" onclick="chatManager.editMessage(${msg.id})" title="Bearbeiten">✏️</button>
                                <button class="btn-message-delete" onclick="chatManager.deleteMessage(${msg.id})" title="Löschen">🗑️</button>
                            </div>
                        ` : ''}
                    </div>
                    <div class="message-content" data-original-text="${this.escapeHtml(msg.message)}">${this.formatMessageText(msg.message)}</div>
                </div>
            `;
        }

        formatMessageText(text) {
            // Einfache Quote-Formatierung nur für ASCII Anführungszeichen
            let result = this.escapeHtml(text);

            // Nur ASCII Anführungszeichen: "text"
               result = result.replace(/"([^"]*)"/g,
                '<span class="quote-text">$&</span>');

            return result;
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async sendMessage() {
            if (!this.activeRoom) return;

            const input = $('#chatInput');
            const message = input.value.trim();

            if (!message) return;

            try {
                const response = await fetch(`/api/chat/rooms/${this.activeRoom}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                if (response.ok) {
                    input.value = '';
                    await this.loadRoomMessages(this.activeRoom);
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (err) {
                alert('Fehler beim Senden der Nachricht');
                console.error(err);
            }
        }

        async loadRoomMembers(roomId) {
            try {
                const response = await fetch(`/api/chat/rooms/${roomId}/members`);
                if (response.ok) {
                    const data = await response.json();
                    this.members.set(roomId, data.members);
                    this.renderMembers();
                }
            } catch (err) {
                console.error('Error loading members:', err);
            }
        }

        renderMembers() {
            const container = $('#memberList');
            const members = this.members.get(this.activeRoom) || [];
            const currentRoom = this.rooms.find(r => r.id === this.activeRoom);

            // Check if current user is room creator
            const isAdmin = currentRoom && currentUser && currentRoom.created_by === currentUser.id;

            container.innerHTML = members.map(member => {
                const canKick = isAdmin && member.user_id !== currentUser.id; // Can't kick yourself

                return `
                    <div class="member-item">
                        <div class="member-info">
                            <span class="member-name">${member.username}</span>
                            <span class="member-role ${member.role}">${member.role}</span>
                        </div>
                        ${canKick ? `<button class="btn-kick" onclick="chatManager.kickMember(${member.user_id})" title="Mitglied entfernen">👢</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        async kickMember(userId) {
            if (!confirm('Mitglied wirklich aus dem Raum entfernen?')) return;

            try {
                const response = await fetch(`/api/chat/rooms/${this.activeRoom}/kick`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });

                if (response.ok) {
                    await this.loadRoomMembers(this.activeRoom);
                    alert('Mitglied erfolgreich entfernt');
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (err) {
                alert('Fehler beim Entfernen des Mitglieds');
                console.error(err);
            }
        }

        deleteMessage(messageId) {
            // Store message ID for later use
            this.pendingDeleteId = messageId;

            // Find the message and show preview
            const messages = this.messages.get(this.activeRoom) || [];
            const message = messages.find(m => m.id === messageId);

            if (message) {
                const preview = $('#deleteMessagePreview');
                preview.innerHTML = `<div class="message-preview-content">"${message.message.substring(0, 100)}${message.message.length > 100 ? '...' : ''}"</div>`;
            }

            openModal('deleteMessageModal');
        }

        async handleConfirmDelete() {
            if (!this.pendingDeleteId) return;

            try {
                const response = await fetch(`/api/chat/messages/${this.pendingDeleteId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await this.loadRoomMessages(this.activeRoom);
                    closeModal('deleteMessageModal');
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (err) {
                alert('Fehler beim Löschen der Nachricht');
                console.error(err);
            } finally {
                this.pendingDeleteId = null;
            }
        }

        editMessage(messageId) {
            // Find the message
            const messages = this.messages.get(this.activeRoom) || [];
            const message = messages.find(m => m.id === messageId);

            if (message) {
                // Populate the edit form
                $('#editMessageId').value = messageId;
                $('#editMessageText').value = message.message;
                this.updateCharCount({ target: $('#editMessageText') });

                openModal('editMessageModal');
                // Focus on textarea
                setTimeout(() => $('#editMessageText').focus(), 100);
            }
        }

        async handleEditMessageSubmit(e) {
            e.preventDefault();
            const messageId = parseInt($('#editMessageId').value);
            const newText = $('#editMessageText').value.trim();

            if (!newText) {
                alert('Nachricht darf nicht leer sein');
                return;
            }

            if (!messageId) {
                alert('Keine Nachrichten-ID gefunden');
                return;
            }

            try {
                const response = await fetch(`/api/chat/messages/${messageId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: newText })
                });

                if (response.ok) {
                    // Success - close modal and reload
                    closeModal('editMessageModal');
                    $('#editMessageForm')[0].reset();
                    await this.loadRoomMessages(this.activeRoom);
                } else {
                    // Server error
                    const error = await response.json();
                    alert(`Server-Fehler: ${error.message}`);
                }
            } catch (err) {
                // Network error - but edit might have worked
                closeModal('editMessageModal');
                $('#editMessageForm')[0].reset();
                await this.loadRoomMessages(this.activeRoom);
            }
        }

        updateCharCount(e) {
            const count = e.target.value.length;
            $('#editCharCount').textContent = count;

            // Change color if approaching limit
            const counter = $('#editCharCount');
            if (count > 2700) {
                counter.style.color = 'var(--warn)';
            } else if (count > 2400) {
                counter.style.color = 'var(--gold)';
            } else {
                counter.style.color = 'var(--muted)';
            }
        }

        toggleMemberSidebar() {
            const sidebar = $('#memberSidebar');
            sidebar.classList.toggle('hidden');
        }

        showCreateRoomModal() {
            openModal('createRoomModal');
        }

        showJoinRoomModal() {
            this.loadAvailableRooms();
            openModal('joinRoomModal');
        }

        async loadAvailableRooms() {
            try {
                const response = await fetch('/api/chat/rooms');
                if (response.ok) {
                    const data = await response.json();
                    this.renderAvailableRooms(data.rooms);
                }
            } catch (err) {
                console.error('Error loading available rooms:', err);
            }
        }

        renderAvailableRooms(rooms) {
            const container = $('#availableRooms');
            container.innerHTML = rooms.map(room => `
                <div class="room-item" onclick="chatManager.joinRoom(${room.id})">
                    <div class="room-name">${room.name} ${room.has_password ? '🔒' : ''}</div>
                    ${room.description ? `<div class="room-description">${room.description}</div>` : ''}
                    <div class="room-meta">
                        <span>👥 ${room.member_count} Mitglieder</span>
                        <span>${room.is_public ? 'Öffentlich' : 'Privat'}</span>
                    </div>
                </div>
            `).join('');
        }

        async handleCreateRoom(e) {
            e.preventDefault();
            console.log('Create room form submitted');

            // Get form element properly
            const form = e.target.tagName === 'FORM' ? e.target : $('#createRoomForm');
            const formData = new FormData(form);
            const isPrivate = formData.get('isPrivate');

            const roomData = {
                name: formData.get('roomName'),
                description: formData.get('description'),
                password: isPrivate ? formData.get('password') : ''
            };

            console.log('Room data:', roomData);

            try {
                const response = await fetch('/api/chat/rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(roomData)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Room created:', result);
                    closeModal('createRoomModal');
                    form.reset();
                    await this.loadUserRooms();
                    alert('Raum erfolgreich erstellt!');
                } else {
                    const error = await response.json();
                    console.error('API Error:', error);
                    alert(`Fehler: ${error.message}`);
                }
            } catch (err) {
                console.error('Network error:', err);
                alert('Fehler beim Erstellen des Raums');
            }
        }

        async joinRoom(roomId, password = '') {
            const room = this.rooms.find(r => r.id === roomId);
            if (!room) {
                // Room not in our list, need to check if it has password
                if (!password) {
                    this.showPasswordModal(roomId);
                    return;
                }
            }

            try {
                const response = await fetch(`/api/chat/rooms/${roomId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    closeModal('joinRoomModal');
                    closeModal('passwordModal');
                    await this.loadUserRooms();
                    // Switch to the joined room
                    await this.switchToRoom(roomId);
                } else {
                    const error = await response.json();
                    if (error.message.includes('Passwort')) {
                        this.showPasswordModal(roomId);
                    } else {
                        alert(`Fehler: ${error.message}`);
                    }
                }
            } catch (err) {
                alert('Fehler beim Beitreten des Raums');
                console.error(err);
            }
        }

        showPasswordModal(roomId) {
            $('#passwordForm input[name="roomId"]').value = roomId;
            closeModal('joinRoomModal');
            openModal('passwordModal');
        }

        async handlePasswordSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const roomId = parseInt(formData.get('roomId'));
            const password = formData.get('password');

            try {
                await this.joinRoom(roomId, password);
                e.target.reset();
            } catch (err) {
                console.error('Error in handlePasswordSubmit:', err);
            }
        }

        async leaveRoom(roomId) {
            if (!confirm('Raum wirklich verlassen?')) return;

            try {
                const response = await fetch(`/api/chat/rooms/${roomId}/leave`, {
                    method: 'POST'
                });

                if (response.ok) {
                    if (this.activeRoom === roomId) {
                        this.activeRoom = null;
                        $('#activeRoomName').textContent = 'Allgemein';
                        $('#chatMessages').innerHTML = '<div class="chat-placeholder">Wähle einen Raum...</div>';
                        $('#chatInput').disabled = true;
                        $('#sendBtn').disabled = true;
                        $('#shareCharBtn').disabled = true;
                        this.stopPolling();
                    }
                    await this.loadUserRooms();
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (err) {
                alert('Fehler beim Verlassen des Raums');
                console.error(err);
            }
        }

        shareCurrentCharacter() {
            const activePanel = getActivePanel();
            if (!activePanel) {
                alert('Kein Charakter aktiv');
                return;
            }

            const data = getPanelData(activePanel);
            const shareText = `[Charakter: ${data.name}] STR:${data.staerke} GES:${data.geschicklichkeit} WAH:${data.wahrnehmung} WIL:${data.willenskraft}`;

            $('#chatInput').value = shareText;
        }

        startPolling() {
            this.stopPolling();
            this.pollInterval = setInterval(() => {
                if (this.activeRoom) {
                    this.pollForNewMessages();
                }
            }, 3000);
        }

        stopPolling() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
            }
        }

        async pollForNewMessages() {
            if (!this.activeRoom) return;

            try {
                const response = await fetch(`/api/chat/rooms/${this.activeRoom}/messages`);
                if (response.ok) {
                    const data = await response.json();
                    const currentMessages = this.messages.get(this.activeRoom) || [];

                    if (data.messages.length > currentMessages.length) {
                        this.messages.set(this.activeRoom, data.messages);
                        this.renderMessages();
                    }
                }
            } catch (err) {
                console.error('Polling error:', err);
            }
        }

        // Chat Settings Methods
        showChatSettings() {
            this.loadChatSettingsUI();
            openModal('chatSettingsModal');
        }

        async loadChatSettingsUI() {
            const settings = await this.getChatSettings();
            $('#normalTextColor').value = settings.normalColor;
            $('#quoteTextColor').value = settings.quoteColor;
            $('#fontSize').value = settings.fontSize;
            $('#fontSizeValue').textContent = settings.fontSize + 'px';
            $('#fontFamily').value = settings.fontFamily;
            this.updatePreview();
        }

        updatePreview() {
            const preview = $('#messagePreview .message-content');
            const normalColor = $('#normalTextColor').value;
            const quoteColor = $('#quoteTextColor').value;
            const fontSize = $('#fontSize').value + 'px';
            const fontFamily = $('#fontFamily').value;

            preview.style.color = normalColor;
            preview.style.fontSize = fontSize;
            preview.style.fontFamily = fontFamily;

            // Update quote text color
            const quoteSpan = preview.querySelector('.quote-text') || document.createElement('span');
            if (!quoteSpan.parentNode) {
                quoteSpan.className = 'quote-text';
                quoteSpan.innerHTML = '„Das ist gesprochener Text in deutschen Anführungszeichen."';
                preview.innerHTML = 'Das ist ein normaler Text. ' + quoteSpan.outerHTML;
            }
            quoteSpan.style.color = quoteColor;
        }

        async saveChatSettings() {
            const settings = {
                normalColor: $('#normalTextColor').value,
                quoteColor: $('#quoteTextColor').value,
                fontSize: parseInt($('#fontSize').value),
                fontFamily: $('#fontFamily').value
            };

            try {
                const response = await fetch('/api/user/chat-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    this.applyChatSettings(settings);
                    closeModal('chatSettingsModal');
                    alert('Settings erfolgreich gespeichert!');
                } else {
                    const error = await response.json();
                    alert(`Fehler beim Speichern: ${error.message}`);
                }
            } catch (err) {
                console.error('Error saving settings:', err);
                alert('Netzwerkfehler beim Speichern der Settings');
            }
        }

        async resetChatSettings() {
            const defaults = this.getDefaultSettings();

            try {
                const response = await fetch('/api/user/chat-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(defaults)
                });

                if (response.ok) {
                    this.applyChatSettings(defaults);
                    await this.loadChatSettingsUI();
                    alert('Settings zurückgesetzt!');
                } else {
                    const error = await response.json();
                    alert(`Fehler beim Zurücksetzen: ${error.message}`);
                }
            } catch (err) {
                console.error('Error resetting settings:', err);
                alert('Netzwerkfehler beim Zurücksetzen der Settings');
            }
        }

        async getChatSettings() {
            try {
                const response = await fetch('/api/user/chat-settings');
                if (response.ok) {
                    const data = await response.json();
                    return data.settings;
                } else {
                    console.error('Failed to load settings, using defaults');
                    return this.getDefaultSettings();
                }
            } catch (err) {
                console.error('Error loading settings:', err);
                return this.getDefaultSettings();
            }
        }

        getDefaultSettings() {
            return {
                normalColor: '#e9eef3',
                quoteColor: '#4ec9b0',
                fontSize: 14,
                fontFamily: "Inter, 'Segoe UI', Arial, sans-serif"
            };
        }

        applyChatSettings(settings) {
            const root = document.documentElement;
            root.style.setProperty('--chat-normal-color', settings.normalColor);
            root.style.setProperty('--chat-quote-color', settings.quoteColor);
            root.style.setProperty('--chat-font-size', settings.fontSize + 'px');
            root.style.setProperty('--chat-font-family', settings.fontFamily);
        }

        async loadChatSettings() {
            const settings = await this.getChatSettings();
            this.applyChatSettings(settings);
        }
    }

    // Modal helper functions
    window.openModal = function(modalId) {
        document.getElementById(modalId).classList.add('open');
    };

    window.closeModal = function(modalId) {
        document.getElementById(modalId).classList.remove('open');
    };

    // Initialize chat manager
    console.log('Current user:', currentUser);
    if (currentUser) {
        console.log('Initializing ChatManager...');
        window.chatManager = new ChatManager();
        console.log('ChatManager initialized:', window.chatManager);
    } else {
        console.log('User not logged in, ChatManager not initialized');
    }
})();
</script>
{% endblock %}